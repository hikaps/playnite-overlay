name: CI (develop)

on:
  push:
    branches:
      - develop
      - 'feat/**'
  pull_request:
    branches: [ develop ]

jobs:
  build:
    runs-on: windows-latest
    env:
      DOTNET_NOLOGO: true
      DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
      DOTNET_CLI_TELEMETRY_OPTOUT: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            6.0.x
            7.0.x

      - name: .NET Info
        run: dotnet --info

      - name: Restore Plugin
        run: dotnet restore src/OverlayPlugin/OverlayPlugin.csproj

      - name: Restore UI
        run: dotnet restore src/OverlayUI/OverlayUI.csproj

      - name: Build Plugin (Release)
        run: dotnet build src/OverlayPlugin/OverlayPlugin.csproj -c Release --no-restore

      - name: Build UI (Release)
        run: dotnet build src/OverlayUI/OverlayUI.csproj -c Release --no-restore
        continue-on-error: true

      - name: Test
        run: dotnet test tests/OverlayPlugin.Tests/OverlayPlugin.Tests.csproj -c Release --no-build
        continue-on-error: true

      - name: Determine version
        id: ver
        shell: pwsh
        run: |
          $v = (Select-String -Path 'extension/extension.yaml' -Pattern '^Version:\s*(.+)$').Matches.Groups[1].Value.Trim()
          if (-not $v) { $v = "0.0.0" }
          $sha = (git rev-parse --short HEAD).Trim()
          $branch = $env:GITHUB_REF_NAME
          if (-not $branch) { $branch = (git rev-parse --abbrev-ref HEAD).Trim() }
          $safeBranch = $branch -replace "[^A-Za-z0-9._-]","-"
          "version=$v`nsha=$sha`nbranch=$branch`nsafeBranch=$safeBranch" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Package .pext
        shell: pwsh
        run: |
          $ver = "${{ steps.ver.outputs.version }}-${{ steps.ver.outputs.safeBranch }}-${{ steps.ver.outputs.sha }}"
          pwsh -File tools/pack.ps1 -Version $ver -OutDir dist

      - name: List dist
        if: always()
        shell: pwsh
        run: |
          if (Test-Path dist) {
            Get-ChildItem dist -Recurse | Select-Object FullName, Length
          } else {
            Write-Host "No dist directory to list."
          }

      - name: Upload .pext artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pext-${{ steps.ver.outputs.version }}-${{ steps.ver.outputs.safeBranch }}-${{ steps.ver.outputs.sha }}
          path: dist/*.pext
          if-no-files-found: warn

name: Release

on:
  push:
    branches: [main]

jobs:
  release:
    name: Build and Release
    runs-on: windows-latest
    permissions:
      contents: write
    env:
      DOTNET_NOLOGO: true
      DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
      DOTNET_CLI_TELEMETRY_OPTOUT: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            6.0.x
            8.0.x

      - name: Cache NuGet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore
        run: |
          dotnet restore src/OverlayPlugin/OverlayPlugin.csproj
          dotnet restore src/OverlayUI/OverlayUI.csproj

      - name: Build Plugin
        run: dotnet build src/OverlayPlugin/OverlayPlugin.csproj -c Release --no-restore

      - name: Build UI
        run: dotnet build src/OverlayUI/OverlayUI.csproj -c Release --no-restore

      - name: Determine version
        id: ver
        shell: pwsh
        run: |
          $v = (Select-String -Path 'extension/extension.yaml' -Pattern '^Version:\s*(.+)$').Matches.Groups[1].Value.Trim()
          if (-not $v) { $v = "0.0.0" }
          "version=$v" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Package .pext
        shell: pwsh
        run: pwsh tools/pack.ps1 -Version "${{ steps.ver.outputs.version }}" -OutDir dist

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pext-${{ steps.ver.outputs.version }}
          path: dist/*.pext

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.ver.outputs.version }}
          name: v${{ steps.ver.outputs.version }}
          draft: true
          files: dist/*.pext
